<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Quantum Dots 3D Viewer</title>
  <!-- Use a build of 3Dmol.js that defines $3Dmol -->
  <script src="https://cdn.jsdelivr.net/npm/3dmol@2.1.0/build/3Dmol-min.js"></script>
  <style>
    body {
      font-family: sans-serif;
      margin: 2em;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    #controls {
      display: flex;
      flex-wrap: wrap;
      gap: 1em;
      margin-bottom: 1em;
      width: 100%;
      max-width: 900px;
    }
    #controls > div {
      display: flex;
      flex-direction: column;
      min-width: 160px;
    }
    #controls label {
      margin-bottom: 0.3em;
      font-weight: bold;
    }
    select, input[type="color"], button {
      padding: 0.3em;
      font-size: 1em;
      width: 100%;
      box-sizing: border-box;
    }
    button {
      cursor: pointer;
    }
    #structure-details {
      margin: 1em 0;
      border: 1px solid #ccc;
      padding: 1em;
      background: #f8f8f8;
      width: 100%;
      max-width: 900px;
      box-sizing: border-box;
    }
    #viewer {
      width: 100%;
      max-width: 900px;
      height: 600px;
      border: 1px solid #ccc;
      position: relative;
    }
    #color-controls {
      margin-top: 1em;
      display: flex;
      flex-wrap: wrap;
      gap: 1em;
    }
    .color-picker {
      display: flex;
      align-items: center;
      gap: 0.5em;
    }
    .color-picker label {
      display: flex;
      align-items: center;
      gap: 0.5em;
      margin: 0;
      font-weight: normal;
    }
  </style>
</head>
<body>
  <h2>Quantum Dots 3D Viewer</h2>

  <div id="controls">
    <div>
      <label for="filter-system">System Type:</label>
      <select id="filter-system">
        <option value="">— Select System —</option>
      </select>
    </div>
    <div>
      <label for="filter-material">Material:</label>
      <select id="filter-material" disabled>
        <option value="">— Select Material —</option>
      </select>
    </div>
    <div>
      <label for="filter-size">Size (nm):</label>
      <select id="filter-size" disabled>
        <option value="">— Select Size —</option>
      </select>
    </div>
    <div>
      <label for="filter-functional">DFT Functional:</label>
      <select id="filter-functional" disabled>
        <option value="">— Select Functional —</option>
      </select>
    </div>
    <div>
      <label for="filter-runtype">Run Type:</label>
      <select id="filter-runtype" disabled>
        <option value="">— Select Run Type —</option>
      </select>
    </div>
    <div>
      <label for="xyz-file">Structure File:</label>
      <select id="xyz-file" disabled>
        <option value="">— Select File —</option>
      </select>
    </div>
    <div>
      <label for="style">Rendering Style:</label>
      <select id="style" disabled>
        <option value="stick">Stick</option>
        <option value="ballstick">Ball &amp; Stick</option>
        <option value="sphere">Space Filling (CPK)</option>
      </select>
    </div>
    <div>
      <label>&nbsp;</label>
      <button id="download-btn" disabled>Download Structure</button>
    </div>
    <div>
      <label>&nbsp;</label>
      <button id="download-png-btn" disabled>Download PNG</button>
    </div>
  </div>

  <!-- CAT integration panel -->
  <details>
    <summary>Attach Ligand (CAT)</summary>
    <div style="margin-top:0.5em;">
      <label for="smiles-input">SMILES:
        <input id="smiles-input" type="text" value="C(=O)O" placeholder="e.g. C(=O)O" />
      </label>
      <label style="margin-left:1em;">
        <input type="checkbox" id="split-checkbox" checked /> split
      </label>
      <button id="run-cat-btn" disabled style="margin-left:1em;">Run CAT</button>
    </div>
    <div id="cat-status" style="margin-top:0.5em; font-size:0.9em; color:#333;">
      Enter a SMILES and click “Run CAT” after selecting a QD.
    </div>
    <div style="margin-top:0.5em;">
      <label for="cat-output-select"><b>Choose CAT output:</b></label>
      <select id="cat-output-select" disabled style="margin-left:0.5em; min-width:200px;">
        <option value="">— none —</option>
      </select>
      <button id="download-catxyz-btn" disabled style="margin-left:1em;">Download CAT‐XYZ</button>
    </div>
  </details>

  <div id="structure-details">
    <b>Structure Details</b>
    <div id="details-content">Select a structure to see details.</div>
    <div id="color-controls"></div>
  </div>

  <div id="viewer"></div>

  <!-- Auto-generated by make_file_list.py -->
  <script src="file_list.js"></script>
  <script>
    let metadata = {};
    // Load metadata.json
    fetch('metadata.json')
      .then(response => response.json())
      .then(data => {
        metadata = data;
        populateSystemTypes();
      })
      .catch(() => {
        console.warn('Could not load metadata.json');
      });

    // DOM references
    const filterSystem     = document.getElementById('filter-system');
    const filterMaterial   = document.getElementById('filter-material');
    const filterSize       = document.getElementById('filter-size');
    const filterFunctional = document.getElementById('filter-functional');
    const filterRunType    = document.getElementById('filter-runtype');
    const selectFile       = document.getElementById('xyz-file');
    const styleSelect      = document.getElementById('style');
    const downloadBtn      = document.getElementById('download-btn');
    const downloadPngBtn   = document.getElementById('download-png-btn');
    const viewerDiv        = document.getElementById('viewer');
    const detailsDiv       = document.getElementById('details-content');
    const colorControlsDiv = document.getElementById('color-controls');
    let viewer = null;
    let currentFile = "";
    let currentXYZText = "";   // ← will store the raw XYZ we fetched

    // Default CPK-like colors
    const defaultColors = {
      "H": "#FFFFFF",  "C": "#909090",  "N": "#3050F8",  "O": "#FF0D0D",
      "S": "#FFFF30",  "P": "#FF8000",  "Cl": "#1FF01F", "Br": "#A62929",
      "I": "#6600AA",  "Cd": "#FFD700", "Se": "#FFA500", "Pb": "#808080"
    };

    // Helper: Convert "#RRGGBB" → "0xRRGGBB"
    function hexToXYZColor(hex) {
      return "0x" + hex.slice(1);
    }

    // Apply custom element-color overrides
    function applyColorOverrides() {
      if (!viewer) return;
      const pickers = colorControlsDiv.querySelectorAll('input[type="color"]');
      pickers.forEach(input => {
        const el = input.dataset.element;
        const hex = input.value;
        const xyzColor = hexToXYZColor(hex);
        viewer.setStyle({ elem: el }, {
          stick: { color: xyzColor },
          sphere: { color: xyzColor }
        });
      });
    }

    // Set rendering style
    function setStyle(style) {
      if (!viewer) return;
      viewer.setStyle({}, {});
      if (style === 'stick') {
        viewer.setStyle({}, { stick: {} });
      } else if (style === 'ballstick') {
        viewer.setStyle({}, { stick: {}, sphere: { scale: 0.3 } });
      } else if (style === 'sphere') {
        viewer.setStyle({}, { sphere: {} });
      }
      viewer.zoomTo();
      viewer.render();
    }

    // Create color pickers for each element
    function setupColorControls(stoich) {
      colorControlsDiv.innerHTML = '';
      const elements = Object.keys(stoich || {});
      if (!elements.length) return;
      elements.forEach(el => {
        const defaultHex = defaultColors[el] || "#CCCCCC";
        const wrapper = document.createElement('div');
        wrapper.className = 'color-picker';
        const label = document.createElement('label');
        label.innerText = el;
        const input = document.createElement('input');
        input.type = 'color';
        input.value = defaultHex;
        input.dataset.element = el;
        input.addEventListener('input', () => {
          applyColorOverrides();
          viewer.render();
        });
        label.appendChild(input);
        wrapper.appendChild(label);
        colorControlsDiv.appendChild(wrapper);
      });
    }

    // Update the details panel
    function updateDetails(filepath) {
      const meta = metadata[filepath];
      if (!meta) {
        detailsDiv.innerHTML = "<i>No metadata available for this structure.</i>";
        colorControlsDiv.innerHTML = "";
        return;
      }
      const stoich = Object.entries(meta.stoichiometry || {})
        .map(([el, cnt]) => `${el} (${cnt})`).join(", ") || "N/A";
      const ratios = Object.entries(meta.ratios || {})
        .map(([pair, val]) => `${pair} = ${val}`).join(", ") || "N/A";
      const sizeDisplay = meta.size != null ? `${meta.size} nm` : "N/A";

      detailsDiv.innerHTML = `
        <b>System type:</b> ${meta.system_type || "N/A"}<br>
        <b>Material:</b> ${meta.material || "N/A"}<br>
        <b>Size:</b> ${sizeDisplay}<br>
        <b>DFT functional:</b> ${meta.functional || "N/A"}<br>
        <b>Basis set:</b> ${meta.basis || "N/A"}<br>
        <b>DFT code:</b> ${meta.code || "N/A"}<br>
        <b>Run Type:</b> ${meta.run_type || "N/A"}<br>
        <b>Stoichiometry:</b> ${stoich}<br>
        <b>Ratios:</b> ${ratios}<br>
        <b>Filename:</b> ${meta.filename}
      `;

      setupColorControls(meta.stoichiometry);
      applyColorOverrides();
    }

    // Load and render the chosen XYZ file (multi-frame MD if supported)
    function loadXYZ(file) {
      currentFile = file;
      downloadBtn.disabled = false;
      downloadBtn.innerText = `Download ${file.split('/').pop()}`;
      downloadPngBtn.disabled = false;
      downloadPngBtn.innerText = `Download PNG`;

      fetch(`./${file}`)
        .then(resp => {
          if (!resp.ok) throw new Error("File not found");
          return resp.text();
        })
        .then(data => {

          // Store the raw XYZ (or first-frame if MD) into currentXYZText
          const meta = metadata[file] || {};
          let xyzToLoad = data;
          if (meta.run_type === "Molecular Dynamics") {
            const lines = data.split('\n');
            const n = parseInt(lines[0].trim());
            xyzToLoad = lines.slice(0, n + 2).join('\n');
          }
          currentXYZText = xyzToLoad;
      
          viewerDiv.innerHTML = '';
          viewer = $3Dmol.createViewer(viewerDiv, { backgroundColor: 'white' });

          if (meta.run_type === "Molecular Dynamics" && viewer.addModelsAsFrames) {
            // Use addModelsAsFrames() if available for multi-frame MD
            viewer.addModelsAsFrames(data, 'xyz');
            setStyle(styleSelect.value);
            viewer.setAnimationMode("loop");
            viewer.animate({ loop: true, step: 100 });
          } else {
            // Fallback: single-frame using the first frame
            viewer.addModel(xyzToLoad, 'xyz');
            setStyle(styleSelect.value);
          }

          updateDetails(file);
          afterLoadSuccess();
        })
        .catch(err => {
          console.error("Error fetching", file, "→", err);
          viewerDiv.innerHTML = "<b>Error loading file.</b>";
          detailsDiv.innerHTML = "<b>No details available.</b>";
          colorControlsDiv.innerHTML = "";
        });
    }

    // Trigger download of the raw .xyz
    downloadBtn.addEventListener('click', () => {
      if (!currentFile) return;
      const link = document.createElement('a');
      link.href = `./${currentFile}`;
      link.download = currentFile.split('/').pop();
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    });

    // Trigger download of a PNG snapshot of the viewer
    downloadPngBtn.addEventListener('click', () => {
      if (!viewer) return;
      // Ensure the viewer is rendered
      viewer.render();
      // Get the PNG data URI of the canvas
      const uri = viewer.pngURI();
      // Create a temporary link to download
      const link = document.createElement('a');
      link.href = uri;
      const pngName = (currentFile.split('/').pop().replace(/\.xyz$/i, '')) + '.png';
      link.download = pngName;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    });

    // Populate the “System Type” dropdown
    function populateSystemTypes() {
      const systems = new Set();
      for (const relpath in metadata) {
        const m = metadata[relpath];
        if (m.system_type) systems.add(m.system_type);
      }
      Array.from(systems).sort().forEach(val => {
        const opt = document.createElement('option');
        opt.value = val;
        opt.text = val;
        filterSystem.appendChild(opt);
      });
    }

    // Populate “Material” based on selected system
    function populateMaterials() {
      filterMaterial.innerHTML = '<option value="">— Select Material —</option>';
      const selectedSystem = filterSystem.value;
      const mats = new Set();
      for (const relpath in metadata) {
        const m = metadata[relpath];
        if (m.system_type === selectedSystem) {
          if (m.material) mats.add(m.material);
        }
      }
      Array.from(mats).sort().forEach(val => {
        const opt = document.createElement('option');
        opt.value = val;
        opt.text = val;
        filterMaterial.appendChild(opt);
      });
      filterMaterial.disabled = mats.size === 0;
    }

    // Populate “Size” based on system + material
    function populateSizes() {
      filterSize.innerHTML = '<option value="">— Select Size —</option>';
      const sysVal = filterSystem.value;
      const matVal = filterMaterial.value;
      const sizes = new Set();
      for (const relpath in metadata) {
        const m = metadata[relpath];
        if (m.system_type === sysVal && m.material === matVal && m.size != null) {
          sizes.add(m.size);
        }
      }
      Array.from(sizes).sort((a, b) => a - b).forEach(val => {
        const opt = document.createElement('option');
        opt.value = val;
        opt.text = `${val} nm`;
        filterSize.appendChild(opt);
      });
      filterSize.disabled = sizes.size === 0;
    }

    // Populate “DFT Functional” based on system + material + size
    function populateFunctionals() {
      filterFunctional.innerHTML = '<option value="">— Select Functional —</option>';
      const sysVal = filterSystem.value;
      const matVal = filterMaterial.value;
      const sizeVal = parseFloat(filterSize.value);
      const funcs = new Set();
      for (const relpath in metadata) {
        const m = metadata[relpath];
        if (
          m.system_type === sysVal &&
          m.material === matVal &&
          m.size === sizeVal &&
          m.functional
        ) {
          funcs.add(m.functional);
        }
      }
      Array.from(funcs).sort().forEach(val => {
        const opt = document.createElement('option');
        opt.value = val;
        opt.text = val;
        filterFunctional.appendChild(opt);
      });
      filterFunctional.disabled = funcs.size === 0;
    }

    // Populate “Run Type” based on system + material + size + functional
    function populateRunTypes() {
      filterRunType.innerHTML = '<option value="">— Select Run Type —</option>';
      const sysVal = filterSystem.value;
      const matVal = filterMaterial.value;
      const sizeVal = parseFloat(filterSize.value);
      const funcVal = filterFunctional.value;
      const runs = new Set();
      for (const relpath in metadata) {
        const m = metadata[relpath];
        if (
          m.system_type === sysVal &&
          m.material === matVal &&
          m.size === sizeVal &&
          m.functional === funcVal &&
          m.run_type
        ) {
          runs.add(m.run_type);
        }
      }
      Array.from(runs).sort().forEach(val => {
        const opt = document.createElement('option');
        opt.value = val;
        opt.text = val;
        filterRunType.appendChild(opt);
      });
      filterRunType.disabled = runs.size === 0;
    }

    // Populate the “Structure File” dropdown based on all previous selections
    function populateFileList() {
      selectFile.innerHTML = '<option value="">— Select File —</option>';
      const sysVal = filterSystem.value;
      const matVal = filterMaterial.value;
      const sizeVal = parseFloat(filterSize.value);
      const funcVal = filterFunctional.value;
      const runVal = filterRunType.value;
      const matches = [];

      for (const relpath in metadata) {
        const m = metadata[relpath];
        if (
          m.system_type === sysVal &&
          m.material === matVal &&
          m.size === sizeVal &&
          m.functional === funcVal &&
          m.run_type === runVal
        ) {
          matches.push(relpath);
        }
      }

      matches.sort();
      matches.forEach(relpath => {
        const opt = document.createElement('option');
        opt.value = relpath;
        opt.text = metadata[relpath].filename;
        selectFile.appendChild(opt);
      });

      if (matches.length > 0) {
        selectFile.disabled = false;
        styleSelect.disabled = false;   // ensure style selector is enabled
        downloadBtn.disabled = false;
        downloadPngBtn.disabled = false;
        // Select and display the first file that was loaded
        selectFile.value = matches[0];
        loadXYZ(matches[0]);
      } else {
        selectFile.disabled = true;
        styleSelect.disabled = true;
        downloadBtn.disabled = true;
        downloadPngBtn.disabled = true;
        viewerDiv.innerHTML = "<b>No structure to display</b>";
        detailsDiv.innerHTML = "<i>No details available.</i>";
        colorControlsDiv.innerHTML = "";
      }
    }

    // Event listeners chaining
    filterSystem.addEventListener('change', () => {
      if (filterSystem.value) {
        populateMaterials();
        filterMaterial.value = "";
        filterMaterial.disabled = false;
      } else {
        filterMaterial.innerHTML = '<option value="">— Select Material —</option>';
        filterMaterial.disabled = true;
      }
      filterSize.innerHTML = '<option value="">— Select Size —</option>';
      filterSize.disabled = true;
      filterFunctional.innerHTML = '<option value="">— Select Functional —</option>';
      filterFunctional.disabled = true;
      filterRunType.innerHTML = '<option value="">— Select Run Type —</option>';
      filterRunType.disabled = true;
      selectFile.innerHTML = '<option value="">— Select File —</option>';
      selectFile.disabled = true;
      styleSelect.disabled = true;
      downloadBtn.disabled = true;
      downloadPngBtn.disabled = true;
      viewerDiv.innerHTML = "<b>Select a System Type first</b>";
      detailsDiv.innerHTML = "";
      colorControlsDiv.innerHTML = "";
    });

    filterMaterial.addEventListener('change', () => {
      if (filterMaterial.value) {
        populateSizes();
        filterSize.value = "";
        filterSize.disabled = false;
      } else {
        filterSize.innerHTML = '<option value="">— Select Size —</option>';
        filterSize.disabled = true;
      }
      filterFunctional.innerHTML = '<option value="">— Select Functional —</option>';
      filterFunctional.disabled = true;
      filterRunType.innerHTML = '<option value="">— Select Run Type —</option>';
      filterRunType.disabled = true;
      selectFile.innerHTML = '<option value="">— Select File —</option>';
      selectFile.disabled = true;
      styleSelect.disabled = true;
      downloadBtn.disabled = true;
      downloadPngBtn.disabled = true;
      viewerDiv.innerHTML = "<b>Select a Material first</b>";
      detailsDiv.innerHTML = "";
      colorControlsDiv.innerHTML = "";
    });

    filterSize.addEventListener('change', () => {
      if (filterSize.value) {
        populateFunctionals();
        filterFunctional.value = "";
        filterFunctional.disabled = false;
      } else {
        filterFunctional.innerHTML = '<option value="">— Select Functional —</option>';
        filterFunctional.disabled = true;
      }
      filterRunType.innerHTML = '<option value="">— Select Run Type —</option>';
      filterRunType.disabled = true;
      selectFile.innerHTML = '<option value="">— Select File —</option>';
      selectFile.disabled = true;
      styleSelect.disabled = true;
      downloadBtn.disabled = true;
      downloadPngBtn.disabled = true;
      viewerDiv.innerHTML = "<b>Select a Size first</b>";
      detailsDiv.innerHTML = "";
      colorControlsDiv.innerHTML = "";
    });

    filterFunctional.addEventListener('change', () => {
      if (filterFunctional.value) {
        populateRunTypes();
        filterRunType.value = "";
        filterRunType.disabled = false;
      } else {
        filterRunType.innerHTML = '<option value="">— Select Run Type —</option>';
        filterRunType.disabled = true;
      }
      selectFile.innerHTML = '<option value="">— Select File —</option>';
      selectFile.disabled = true;
      styleSelect.disabled = true;
      downloadBtn.disabled = true;
      downloadPngBtn.disabled = true;
      viewerDiv.innerHTML = "<b>Select a Functional first</b>";
      detailsDiv.innerHTML = "";
      colorControlsDiv.innerHTML = "";
    });

    filterRunType.addEventListener('change', () => {
      if (filterRunType.value) {
        populateFileList();
      } else {
        selectFile.innerHTML = '<option value="">— Select File —</option>';
        selectFile.disabled = true;
        styleSelect.disabled = true;
        downloadBtn.disabled = true;
        downloadPngBtn.disabled = true;
        viewerDiv.innerHTML = "<b>Select a Run Type first</b>";
        detailsDiv.innerHTML = "";
        colorControlsDiv.innerHTML = "";
      }
    });

    selectFile.addEventListener('change', () => {
      if (selectFile.value) {
        loadXYZ(selectFile.value);
      }
    });

    styleSelect.addEventListener('change', () => setStyle(styleSelect.value));

    // ─── CAT UI elements ──────────────────────────────────────────────────────
    const runCatBtn   = document.getElementById("run-cat-btn");
    const smilesInput = document.getElementById("smiles-input");
    const splitCheck  = document.getElementById("split-checkbox");
    const catStatus   = document.getElementById("cat-status");
    
    // Disable Run CAT until a structure is loaded
    function enableCatUI(enable) {
      runCatBtn.disabled = !enable;
      if (!enable) {
        catStatus.textContent = "Select a structure first.";
      }
    }
    enableCatUI(false);
    
    // In your loadXYZ(file) success callback, add this line so CAT UI becomes enabled:
    function afterLoadSuccess() {
      enableCatUI(true);
    }
    // At the end of loadXYZ (after updateDetails), call:
    afterLoadSuccess();
    
    // ─── Run CAT on button click ──────────────────────────────────────────────
    runCatBtn.addEventListener("click", () => {
      if (!viewer || !currentFile) return;
      const xyzText = currentXYZText;
      catStatus.textContent = "Running CAT…";
      runCatBtn.disabled = true;
    
      fetch("https://cat-backend-integration.onrender.com", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({
          xyztext: xyzText,
          smiles: smilesInput.value.trim(),
          split: splitCheck.checked
        })
      })
      .then(r => {
        if (!r.ok) return r.json().then(err => { throw err; });
        return r.json();
      })
      .then(resp => {
        // If resp is null/undefined (no JSON), bail out early:
        if (!resp) {
          catStatus.textContent = "No response from CAT backend.";
          return;
        }

        // If the backend only returned a single "xyz" (old‐style), wrap it into results[]
        if (!resp.results && resp.xyz) {
          resp = {
            results: [{ filename: "cat_output.xyz", xyz: resp.xyz }],
            message: "Single structure generated"
          };
        }

        // resp.results is an array of { filename, xyz }
        if (!resp.results || !resp.results.length) {
          catStatus.textContent = "CAT returned no structures.";
          return;
        }
    
        // 1) Populate the dropdown (#cat-output-select)
        const outSelect = document.getElementById("cat-output-select");
        outSelect.innerHTML = '<option value="">— choose —</option>';
        resp.results.forEach((entry, idx) => {
          const opt = document.createElement("option");
          opt.value = idx;                  // use index as the value
          opt.text  = entry.filename;       // show “qdXYZ.xyz” or similar
          outSelect.appendChild(opt);
        });
        outSelect.disabled = false;
        catStatus.textContent = resp.message || `Returned ${resp.results.length} structure(s)`;
    
        // 2) Show the first result by default
        const first = resp.results[0];
        loadCATResult(first);   // see helper below
    
        // 3) Enable “Download CAT‐XYZ” button for that first result
        const downloadCatBtn = document.getElementById("download-catxyz-btn");
        downloadCatBtn.disabled = false;
        downloadCatBtn.onclick = () => downloadCATXYZ(first.filename, first.xyz);
    
        // 4) When user picks a different dropdown option, re‐render & update details
        outSelect.onchange = () => {
          const idx = parseInt(outSelect.value);
          if (isNaN(idx) || idx < 0 || idx >= resp.results.length) return;
          const chosen = resp.results[idx];
          loadCATResult(chosen);
          downloadCatBtn.disabled = false;
          downloadCatBtn.onclick = () => downloadCATXYZ(chosen.filename, chosen.xyz);
        };
      })
      .catch(err => {
        catStatus.textContent = "Error: " + (err.detail || err);
        console.error(err);
      })
      .finally(() => runCatBtn.disabled = false);
    });

    /**
     * Helper: render a CAT result (an object { filename, xyz })
     * into the existing 3Dmol viewer and update the “details” panel.
     */
    function loadCATResult(entry) {
      // Clear old viewer
      viewerDiv.innerHTML = "";
      viewer = $3Dmol.createViewer(viewerDiv, { backgroundColor: "white" });
      viewer.addModel(entry.xyz, "xyz");
      setStyle(styleSelect.value);
      viewer.zoomTo();
      viewer.render();
    
      // Recompute simple “structure details” from the raw XYZ text
      // (we do a naive atom‐count from the first frame)
      const lines = entry.xyz.split("\n");
      let nAtoms = parseInt(lines[0].trim()) || 0;
      const stoichCounts = {};
      let start = 2;               // skip the first two lines
      for (let i = 0; i < nAtoms && start + i < lines.length; i++) {
        const tokens = lines[start + i].trim().split(/\s+/);
        if (tokens.length >= 4) {
          const el = tokens[0];
          stoichCounts[el] = (stoichCounts[el]||0) + 1;
        }
      }
      // Build a little HTML snippet for details
      const stoichText = Object.entries(stoichCounts)
        .map(([el, cnt]) => `${el} (${cnt})`).join(", ") || "N/A";
      const ratios = [];
      const elems = Object.keys(stoichCounts);
      for (let i = 0; i < elems.length; i++) {
        for (let j = i+1; j < elems.length; j++) {
          const e1 = elems[i], e2 = elems[j];
          const r1 = (stoichCounts[e1] / stoichCounts[e2]).toFixed(3);
          const r2 = (stoichCounts[e2] / stoichCounts[e1]).toFixed(3);
          ratios.push(`${e1}/${e2} = ${r1}`, `${e2}/${e1} = ${r2}`);
        }
      }
      const ratiosText = ratios.join(", ") || "N/A";
    
      detailsDiv.innerHTML = `
        <b>Filename:</b> ${entry.filename}<br>
        <b>Total atoms:</b> ${nAtoms}<br>
        <b>Stoichiometry:</b> ${stoichText}<br>
        <b>Ratios:</b> ${ratiosText}
      `;
      // Rebuild color pickers based on the new stoichiometry
      setupColorControls(stoichCounts);
      applyColorOverrides();
    }
    
    /**
     * Helper: trigger a download of a CAT result’s XYZ text
     */
    function downloadCATXYZ(fname, xyzText) {
      const blob = new Blob([xyzText], { type: "chemical/x-xyz" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = fname;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

  </script>
</body>
</html>

