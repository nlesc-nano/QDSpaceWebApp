<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Quantum Dots 3D Viewer</title>
  <script src="https://3Dmol.org/build/3Dmol-min.js"></script>
  <style>
    body {
      font-family: sans-serif;
      margin: 2em;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    #controls {
      display: flex;
      flex-wrap: wrap;
      gap: 1em;
      margin-bottom: 1em;
      width: 100%;
      max-width: 900px;
    }
    #controls > div {
      display: flex;
      flex-direction: column;
      min-width: 160px;
    }
    #controls label {
      margin-bottom: 0.3em;
      font-weight: bold;
    }
    select, input[type="color"] {
      padding: 0.3em;
      font-size: 1em;
      width: 100%;
      box-sizing: border-box;
    }
    #structure-details {
      margin: 1em 0;
      border: 1px solid #ccc;
      padding: 1em;
      background: #f8f8f8;
      width: 100%;
      max-width: 900px;
      box-sizing: border-box;
    }
    #viewer {
      width: 100%;
      max-width: 900px;
      height: 600px;
      border: 1px solid #ccc;
      position: relative;
    }
    #color-controls {
      margin-top: 1em;
      display: flex;
      flex-wrap: wrap;
      gap: 1em;
    }
    .color-picker {
      display: flex;
      align-items: center;
      gap: 0.5em;
    }
    .color-picker label {
      margin: 0;
      font-weight: normal;
    }
  </style>
</head>
<body>
  <h2>Quantum Dots 3D Viewer</h2>

  <div id="controls">
    <div>
      <label for="filter-system">System Type:</label>
      <select id="filter-system">
        <option value="">— Select System —</option>
      </select>
    </div>
    <div>
      <label for="filter-material">Material:</label>
      <select id="filter-material" disabled>
        <option value="">— Select Material —</option>
      </select>
    </div>
    <div>
      <label for="filter-size">Size (nm):</label>
      <select id="filter-size" disabled>
        <option value="">— Select Size —</option>
      </select>
    </div>
    <div>
      <label for="filter-functional">DFT Functional:</label>
      <select id="filter-functional" disabled>
        <option value="">— Select Functional —</option>
      </select>
    </div>
    <div>
      <label for="filter-runtype">Run Type:</label>
      <select id="filter-runtype" disabled>
        <option value="">— Select Run Type —</option>
      </select>
    </div>
    <div>
      <label for="xyz-file">Structure File:</label>
      <select id="xyz-file" disabled>
        <option value="">— Select File —</option>
      </select>
    </div>
    <div>
      <label for="style">Rendering Style:</label>
      <select id="style" disabled>
        <option value="stick">Stick</option>
        <option value="ballstick">Ball &amp; Stick</option>
        <option value="sphere">Space Filling (CPK)</option>
      </select>
    </div>
  </div>

  <div id="structure-details">
    <b>Structure Details</b>
    <div id="details-content">Select a structure to see details.</div>
    <div id="color-controls"></div>
  </div>

  <div id="viewer"></div>

  <!-- Auto-generated by make_file_list.py -->
  <script src="file_list.js"></script>
  <script>
    let metadata = {};
    // Load metadata.json
    fetch('metadata.json')
      .then(response => response.json())
      .then(data => {
        metadata = data;
        populateSystemTypes();
      })
      .catch(() => {
        console.warn('Could not load metadata.json');
      });

    // DOM references
    const filterSystem     = document.getElementById('filter-system');
    const filterMaterial   = document.getElementById('filter-material');
    const filterSize       = document.getElementById('filter-size');
    const filterFunctional = document.getElementById('filter-functional');
    const filterRunType    = document.getElementById('filter-runtype');
    const selectFile       = document.getElementById('xyz-file');
    const styleSelect      = document.getElementById('style');
    const viewerDiv        = document.getElementById('viewer');
    const detailsDiv       = document.getElementById('details-content');
    const colorControlsDiv = document.getElementById('color-controls');
    let viewer = null;

    // Default CPK-like colors
    const defaultColors = {
      "H": "#FFFFFF",  "C": "#909090",  "N": "#3050F8",  "O": "#FF0D0D",
      "S": "#FFFF30",  "P": "#FF8000",  "Cl": "#1FF01F", "Br": "#A62929",
      "I": "#6600AA",  "Cd": "#FFD700", "Se": "#FFA500", "Pb": "#808080"
    };

    // Helper: Convert "#RRGGBB" --> "0xRRGGBB"
    function hexToXYZColor(hex) {
      return "0x" + hex.slice(1);
    }

    // Apply custom element-color overrides
    function applyColorOverrides() {
      if (!viewer) return;
      const pickers = colorControlsDiv.querySelectorAll('input[type="color"]');
      pickers.forEach(input => {
        const el = input.dataset.element;
        const hex = input.value;
        const xyzColor = hexToXYZColor(hex);
        viewer.setStyle({ elem: el }, {
          stick: { color: xyzColor },
          sphere: { color: xyzColor }
        });
      });
    }

    // Set rendering style
    function setStyle(style) {
      if (!viewer) return;
      viewer.setStyle({}, {});
      if (style === 'stick') {
        viewer.setStyle({}, { stick: {} });
      } else if (style === 'ballstick') {
        viewer.setStyle({}, { stick: {}, sphere: { scale: 0.3 } });
      } else if (style === 'sphere') {
        viewer.setStyle({}, { sphere: {} });
      }
      applyColorOverrides();
      viewer.zoomTo();
      viewer.render();
    }

    // Create color pickers for each element
    function setupColorControls(stoich) {
      colorControlsDiv.innerHTML = '';
      const elements = Object.keys(stoich || {});
      if (!elements.length) return;
      elements.forEach(el => {
        const defaultHex = defaultColors[el] || "#CCCCCC";
        const wrapper = document.createElement('div');
        wrapper.className = 'color-picker';
        const label = document.createElement('label');
        label.innerText = el;
        const input = document.createElement('input');
        input.type = 'color';
        input.value = defaultHex;
        input.dataset.element = el;
        input.addEventListener('input', () => {
          applyColorOverrides();
          viewer.render();
        });
        wrapper.appendChild(label);
        wrapper.appendChild(input);
        colorControlsDiv.appendChild(wrapper);
      });
    }

    // Update the details panel
    function updateDetails(filepath) {
      const meta = metadata[filepath];
      if (!meta) {
        detailsDiv.innerHTML = "<i>No metadata available for this structure.</i>";
        colorControlsDiv.innerHTML = "";
        return;
      }
      const stoich = Object.entries(meta.stoichiometry || {})
        .map(([el, cnt]) => `${el} (${cnt})`).join(", ") || "N/A";
      const ratios = Object.entries(meta.ratios || {})
        .map(([pair, val]) => `${pair} = ${val}`).join(", ") || "N/A";
      const sizeDisplay = meta.size != null ? `${meta.size} nm` : "N/A";

      detailsDiv.innerHTML = `
        <b>System type:</b> ${meta.system_type || "N/A"}<br>
        <b>Material:</b> ${meta.material || "N/A"}<br>
        <b>Size:</b> ${sizeDisplay}<br>
        <b>DFT functional:</b> ${meta.functional || "N/A"}<br>
        <b>Basis set:</b> ${meta.basis || "N/A"}<br>
        <b>DFT code:</b> ${meta.code || "N/A"}<br>
        <b>Run Type:</b> ${meta.run_type || "N/A"}<br>
        <b>Stoichiometry:</b> ${stoich}<br>
        <b>Ratios:</b> ${ratios}<br>
        <b>Filename:</b> ${meta.filename}
      `;

      setupColorControls(meta.stoichiometry);
    }

    // Load and render the chosen XYZ file
    function loadXYZ(file) {
      fetch(file)
        .then(resp => {
          if (!resp.ok) throw new Error("File not found");
          return resp.text();
        })
        .then(data => {
          viewerDiv.innerHTML = '';
          viewer = $3Dmol.createViewer(viewerDiv, { backgroundColor: 'white' });
          viewer.addModel(data, 'xyz');
          setStyle(styleSelect.value);
          updateDetails(file);
        })
        .catch(() => {
          viewerDiv.innerHTML = "<b>Error loading file.</b>";
          detailsDiv.innerHTML = "<b>No details available.</b>";
          colorControlsDiv.innerHTML = "";
        });
    }

    // Populate the “System Type” dropdown
    function populateSystemTypes() {
      const systems = new Set();
      for (const relpath in metadata) {
        const m = metadata[relpath];
        if (m.system_type) systems.add(m.system_type);
      }
      Array.from(systems).sort().forEach(val => {
        const opt = document.createElement('option');
        opt.value = val;
        opt.text = val;
        filterSystem.appendChild(opt);
      });
    }

    // Populate “Material” based on selected system
    function populateMaterials() {
      filterMaterial.innerHTML = '<option value="">— Select Material —</option>';
      const selectedSystem = filterSystem.value;
      const mats = new Set();
      for (const relpath in metadata) {
        const m = metadata[relpath];
        if (m.system_type === selectedSystem) {
          if (m.material) mats.add(m.material);
        }
      }
      Array.from(mats).sort().forEach(val => {
        const opt = document.createElement('option');
        opt.value = val;
        opt.text = val;
        filterMaterial.appendChild(opt);
      });
      filterMaterial.disabled = mats.size === 0;
    }

    // Populate “Size” based on system + material
    function populateSizes() {
      filterSize.innerHTML = '<option value="">— Select Size —</option>';
      const sysVal = filterSystem.value;
      const matVal = filterMaterial.value;
      const sizes = new Set();
      for (const relpath in metadata) {
        const m = metadata[relpath];
        if (m.system_type === sysVal && m.material === matVal && m.size != null) {
          sizes.add(m.size);
        }
      }
      Array.from(sizes).sort((a, b) => a - b).forEach(val => {
        const opt = document.createElement('option');
        opt.value = val;
        opt.text = `${val} nm`;
        filterSize.appendChild(opt);
      });
      filterSize.disabled = sizes.size === 0;
    }

    // Populate “DFT Functional” based on system + material + size
    function populateFunctionals() {
      filterFunctional.innerHTML = '<option value="">— Select Functional —</option>';
      const sysVal = filterSystem.value;
      const matVal = filterMaterial.value;
      const sizeVal = parseFloat(filterSize.value);
      const funcs = new Set();
      for (const relpath in metadata) {
        const m = metadata[relpath];
        if (m.system_type === sysVal
            && m.material === matVal
            && m.size === sizeVal
            && m.functional) {
          funcs.add(m.functional);
        }
      }
      Array.from(funcs).sort().forEach(val => {
        const opt = document.createElement('option');
        opt.value = val;
        opt.text = val;
        filterFunctional.appendChild(opt);
      });
      filterFunctional.disabled = funcs.size === 0;
    }

    // Populate “Run Type” based on system + material + size + functional
    function populateRunTypes() {
      filterRunType.innerHTML = '<option value="">— Select Run Type —</option>';
      const sysVal = filterSystem.value;
      const matVal = filterMaterial.value;
      const sizeVal = parseFloat(filterSize.value);
      const funcVal = filterFunctional.value;
      const runs = new Set();
      for (const relpath in metadata) {
        const m = metadata[relpath];
        if (m.system_type === sysVal
            && m.material === matVal
            && m.size === sizeVal
            && m.functional === funcVal
            && m.run_type) {
          runs.add(m.run_type);
        }
      }
      Array.from(runs).sort().forEach(val => {
        const opt = document.createElement('option');
        opt.value = val;
        opt.text = val;
        filterRunType.appendChild(opt);
      });
      filterRunType.disabled = runs.size === 0;
    }

    // Populate the “Structure File” dropdown based on all previous selections
    function populateFileList() {
      selectFile.innerHTML = '<option value="">— Select File —</option>';
      const sysVal = filterSystem.value;
      const matVal = filterMaterial.value;
      const sizeVal = parseFloat(filterSize.value);
      const funcVal = filterFunctional.value;
      const runVal = filterRunType.value;
      const matches = [];

      for (const relpath in metadata) {
        const m = metadata[relpath];
        if (m.system_type === sysVal
            && m.material === matVal
            && m.size === sizeVal
            && m.functional === funcVal
            && m.run_type === runVal) {
          matches.push(relpath);
        }
      }

      matches.sort();
      matches.forEach(relpath => {
        const opt = document.createElement('option');
        opt.value = relpath;
        opt.text = metadata[relpath].filename;
        selectFile.appendChild(opt);
      });

      if (matches.length > 0) {
        selectFile.disabled = false;
        styleSelect.disabled = false;
        loadXYZ(matches[0]);
      } else {
        selectFile.disabled = true;
        styleSelect.disabled = true;
        viewerDiv.innerHTML = "<b>No structure to display</b>";
        detailsDiv.innerHTML = "<i>No details available.</i>";
        colorControlsDiv.innerHTML = "";
      }
    }

    // Event listeners chaining
    filterSystem.addEventListener('change', () => {
      if (filterSystem.value) {
        populateMaterials();
        filterMaterial.value = "";
        filterMaterial.disabled = false;
      } else {
        // Reset all downstream filters
        filterMaterial.innerHTML = '<option value="">— Select Material —</option>';
        filterMaterial.disabled = true;
      }
      filterSize.innerHTML = '<option value="">— Select Size —</option>';
      filterSize.disabled = true;
      filterFunctional.innerHTML = '<option value="">— Select Functional —</option>';
      filterFunctional.disabled = true;
      filterRunType.innerHTML = '<option value="">— Select Run Type —</option>';
      filterRunType.disabled = true;
      selectFile.innerHTML = '<option value="">— Select File —</option>';
      selectFile.disabled = true;
      styleSelect.disabled = true;
      viewerDiv.innerHTML = "<b>Select a System Type first</b>";
      detailsDiv.innerHTML = "";
      colorControlsDiv.innerHTML = "";
    });

    filterMaterial.addEventListener('change', () => {
      if (filterMaterial.value) {
        populateSizes();
        filterSize.value = "";
        filterSize.disabled = false;
      } else {
        filterSize.innerHTML = '<option value="">— Select Size —</option>';
        filterSize.disabled = true;
      }
      filterFunctional.innerHTML = '<option value="">— Select Functional —</option>';
      filterFunctional.disabled = true;
      filterRunType.innerHTML = '<option value="">— Select Run Type —</option>';
      filterRunType.disabled = true;
      selectFile.innerHTML = '<option value="">— Select File —</option>';
      selectFile.disabled = true;
      styleSelect.disabled = true;
      viewerDiv.innerHTML = "<b>Select a Material first</b>";
      detailsDiv.innerHTML = "";
      colorControlsDiv.innerHTML = "";
    });

    filterSize.addEventListener('change', () => {
      if (filterSize.value) {
        populateFunctionals();
        filterFunctional.value = "";
        filterFunctional.disabled = false;
      } else {
        filterFunctional.innerHTML = '<option value="">— Select Functional —</option>';
        filterFunctional.disabled = true;
      }
      filterRunType.innerHTML = '<option value="">— Select Run Type —</option>';
      filterRunType.disabled = true;
      selectFile.innerHTML = '<option value="">— Select File —</option>';
      selectFile.disabled = true;
      styleSelect.disabled = true;
      viewerDiv.innerHTML = "<b>Select a Size first</b>";
      detailsDiv.innerHTML = "";
      colorControlsDiv.innerHTML = "";
    });

    filterFunctional.addEventListener('change', () => {
      if (filterFunctional.value) {
        populateRunTypes();
        filterRunType.value = "";
        filterRunType.disabled = false;
      } else {
        filterRunType.innerHTML = '<option value="">— Select Run Type —</option>';
        filterRunType.disabled = true;
      }
      selectFile.innerHTML = '<option value="">— Select File —</option>';
      selectFile.disabled = true;
      styleSelect.disabled = true;
      viewerDiv.innerHTML = "<b>Select a Functional first</b>";
      detailsDiv.innerHTML = "";
      colorControlsDiv.innerHTML = "";
    });

    filterRunType.addEventListener('change', () => {
      if (filterRunType.value) {
        populateFileList();
      } else {
        selectFile.innerHTML = '<option value="">— Select File —</option>';
        selectFile.disabled = true;
        styleSelect.disabled = true;
        viewerDiv.innerHTML = "<b>Select a Run Type first</b>";
        detailsDiv.innerHTML = "";
        colorControlsDiv.innerHTML = "";
      }
    });

    selectFile.addEventListener('change', () => {
      if (selectFile.value) {
        loadXYZ(selectFile.value);
      }
    });

    styleSelect.addEventListener('change', () => setStyle(styleSelect.value));
  </script>
</body>
</html>

