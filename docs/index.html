<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Quantum Dots 3D Viewer</title>
  <script src="https://3Dmol.org/build/3Dmol-min.js"></script>
  <style>
    body {
      font-family: sans-serif;
      margin: 2em;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    #controls {
      display: flex;
      gap: 1.5em;
      flex-wrap: wrap;
      margin-bottom: 1em;
      width: 100%;
      max-width: 900px;
    }
    #controls div {
      display: flex;
      flex-direction: column;
      min-width: 200px;
    }
    #controls label {
      margin-bottom: 0.3em;
      font-weight: bold;
    }
    #structure-details {
      margin: 1em 0;
      border: 1px solid #ccc;
      padding: 1em;
      background: #f8f8f8;
      width: 100%;
      max-width: 900px;
      box-sizing: border-box;
    }
    #viewer {
      width: 100%;
      max-width: 900px;
      height: 600px;
      border: 1px solid #ccc;
      position: relative;
    }
    select, input[type="color"] {
      padding: 0.3em;
      font-size: 1em;
      width: 100%;
      box-sizing: border-box;
    }
    #color-controls {
      margin-top: 1em;
      display: flex;
      flex-wrap: wrap;
      gap: 1em;
    }
    .color-picker {
      display: flex;
      align-items: center;
      gap: 0.5em;
    }
    .color-picker label {
      margin: 0;
      font-weight: normal;
    }
  </style>
</head>
<body>
  <h2>Quantum Dots 3D Viewer</h2>

  <div id="controls">
    <div>
      <label for="xyz-file">Select a structure:</label>
      <select id="xyz-file"></select>
    </div>
    <div>
      <label for="style">Rendering style:</label>
      <select id="style">
        <option value="stick">Stick</option>
        <option value="ballstick">Ball &amp; Stick</option>
        <option value="sphere">Space Filling (CPK)</option>
      </select>
    </div>
  </div>

  <div id="structure-details">
    <b>Structure Details</b>
    <div id="details-content">Select a structure to see details.</div>
    <div id="color-controls"></div>
  </div>

  <div id="viewer"></div>

  <!-- file_list.js is generated by make_file_list.py -->
  <script src="file_list.js"></script>
  <script>
    // ─── Load metadata.json ───────────────────────────────────────────────
    let metadata = {};
    fetch('metadata.json')
      .then(r => r.json())
      .then(data => { metadata = data; })
      .catch(() => { console.warn('Could not load metadata.json'); });

    // ─── DOM references ───────────────────────────────────────────────────
    const select = document.getElementById('xyz-file');
    const styleSelect = document.getElementById('style');
    const viewerDiv = document.getElementById('viewer');
    const detailsDiv = document.getElementById('details-content');
    const colorControlsDiv = document.getElementById('color-controls');
    let viewer = null;

    // ─── Populate the “Select a structure” dropdown ────────────────────────
    xyzFiles.forEach(file => {
      const option = document.createElement('option');
      option.value = file;
      option.text = file;
      select.appendChild(option);
    });

    // ─── Default CPK‐style color map (fallbacks included) ────────────────
    const defaultColors = {
      "H": "#FFFFFF",  "C": "#909090",  "N": "#3050F8",  "O": "#FF0D0D",
      "S": "#FFFF30",  "P": "#FF8000",  "Cl": "#1FF01F", "Br": "#A62929",
      "I": "#6600AA",  "Cd": "#FFD700", "Se": "#FFA500", "Pb": "#808080"
      // …you can add more elements as needed
    };

    // ─── Helper: Convert “#RRGGBB” → “0xRRGGBB” for 3Dmol.js ───────────────
    function hexToXYZColor(hex) {
      return "0x" + hex.slice(1);
    }

    // ─── Apply custom element‐color overrides to the current model ─────────
    function applyColorOverrides() {
      const pickers = colorControlsDiv.querySelectorAll('input[type="color"]');
      pickers.forEach(input => {
        const element = input.dataset.element;        // e.g. "Cd"
        const colorHex = input.value;                // e.g. "#FFD700"
        const xyzColor = hexToXYZColor(colorHex);     // "0xFFD700"
        viewer.setStyle({ elem: element }, {
          stick: { color: xyzColor },
          sphere: { color: xyzColor }
        });
      });
    }

    // ─── Set rendering style (stick / ball & stick / sphere) ─────────────
    function setStyle(style) {
      if (!viewer) return;
      viewer.setStyle({}, {}); // clear all existing styles
      if (style === 'stick') {
        viewer.setStyle({}, { stick: {} });
      } else if (style === 'ballstick') {
        viewer.setStyle({}, { stick: {}, sphere: { scale: 0.3 } });
      } else if (style === 'sphere') {
        viewer.setStyle({}, { sphere: {} });
      }
      applyColorOverrides();
      viewer.zoomTo();
      viewer.render();
    }

    // ─── Create color‐picker controls for each element in stoichiometry ────
    function setupColorControls(stoichiometry) {
      colorControlsDiv.innerHTML = "";
      const elements = Object.keys(stoichiometry || {});
      if (!elements.length) return;

      elements.forEach(el => {
        const defaultHex = defaultColors[el] || "#CCCCCC";
        const wrapper = document.createElement('div');
        wrapper.className = "color-picker";

        const label = document.createElement('label');
        label.innerText = el;

        const input = document.createElement('input');
        input.type = "color";
        input.value = defaultHex;
        input.dataset.element = el;
        input.addEventListener('input', () => {
          applyColorOverrides();
          viewer.render();
        });

        wrapper.appendChild(label);
        wrapper.appendChild(input);
        colorControlsDiv.appendChild(wrapper);
      });
    }

    // ─── Update details panel using metadata for the selected file ────────
    function updateDetails(filepath) {
      const meta = metadata[filepath];
      if (!meta) {
        detailsDiv.innerHTML = "<i>No metadata available for this structure.</i>";
        colorControlsDiv.innerHTML = "";
        return;
      }

      // Stoichiometry string
      const stoich = Object.entries(meta.stoichiometry || {})
        .map(([el, cnt]) => `${el} (${cnt})`)
        .join(", ") || "N/A";

      // Ratios string
      const ratios = Object.entries(meta.ratios || {})
        .map(([pair, val]) => `${pair} = ${val}`)
        .join(", ") || "N/A";

      // Size is always in nm
      const sizeDisplay = meta.size != null ? `${meta.size} nm` : "N/A";

      detailsDiv.innerHTML = `
        <b>System type:</b> ${meta.system_type || "N/A"}<br>
        <b>Material:</b> ${meta.material || "N/A"}<br>
        <b>Size:</b> ${sizeDisplay}<br>
        <b>DFT functional:</b> ${meta.functional || "N/A"}<br>
        <b>Basis set:</b> ${meta.basis || "N/A"}<br>
        <b>DFT code:</b> ${meta.code || "N/A"}<br>
        <b>Run Type:</b> ${meta.run_type || "N/A"}<br>
        <b>Stoichiometry:</b> ${stoich}<br>
        <b>Ratios:</b> ${ratios}<br>
        <b>Filename:</b> ${meta.filename}
      `;

      setupColorControls(meta.stoichiometry);
    }

    // ─── Load & render an XYZ structure, then show details & color pickers ──
    function loadXYZ(file) {
      fetch(file)
        .then(resp => {
          if (!resp.ok) throw new Error("File not found");
          return resp.text();
        })
        .then(data => {
          // Initialize (or reset) the viewer
          viewerDiv.innerHTML = "";
          viewer = $3Dmol.createViewer(viewerDiv, { backgroundColor: 'white' });
          viewer.addModel(data, 'xyz');
          setStyle(styleSelect.value);
          updateDetails(file);
        })
        .catch(() => {
          viewerDiv.innerHTML = "<b>Error loading file.</b>";
          detailsDiv.innerHTML = "<b>No details available.</b>";
          colorControlsDiv.innerHTML = "";
        });
    }

    // ─── Initial load (if any files exist) ────────────────────────────────
    if (xyzFiles.length > 0) {
      loadXYZ(xyzFiles[0]);
    }

    // ─── Event listeners ─────────────────────────────────────────────────
    select.addEventListener("change", () => loadXYZ(select.value));
    styleSelect.addEventListener("change", () => setStyle(styleSelect.value));
  </script>
</body>
</html>


