<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Quantum Dots 3D Viewer</title>
  <script src="https://3Dmol.org/build/3Dmol-min.js"></script>
  <style>
    body {
      font-family: sans-serif;
      margin: 2em;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    #controls {
      display: flex;
      gap: 1em;
      margin-bottom: 1em;
      width: 90%;
      max-width: 900px;
    }
    #controls label {
      margin-right: 0.5em;
    }
    #structure-details {
      margin: 1em 0;
      border: 1px solid #ccc;
      padding: 1em;
      background: #f8f8f8;
      width: 90%;
      max-width: 900px;
    }
    #viewer {
      width: 90%;
      max-width: 900px;
      height: 600px;
      border: 1px solid #ccc;
      position: relative;
    }
    select {
      padding: 0.3em;
      font-size: 1em;
    }
  </style>
</head>
<body>
  <h2>Quantum Dots 3D Viewer</h2>
  
  <div id="controls">
    <div>
      <label for="xyz-file">Select a structure:</label>
      <select id="xyz-file"></select>
    </div>
    <div>
      <label for="style">Rendering style:</label>
      <select id="style">
        <option value="stick">Stick</option>
        <option value="ballstick">Ball &amp; Stick</option>
        <option value="sphere">Space Filling (CPK)</option>
      </select>
    </div>
  </div>
  
  <div id="structure-details">
    <b>Structure Details</b>
    <div id="details-content">Select a structure to see details.</div>
  </div>
  
  <div id="viewer"></div>
  
  <!-- This file is generated by make_file_list.py -->
  <script src="file_list.js"></script>
  <script>
    // Load metadata.json
    let metadata = {};
    fetch('metadata.json')
      .then(response => response.json())
      .then(data => {
        metadata = data;
      })
      .catch(() => {
        console.warn('Could not load metadata.json');
      });

    const select = document.getElementById('xyz-file');
    const styleSelect = document.getElementById('style');
    const viewerDiv = document.getElementById('viewer');
    let viewer = null;

    // Populate the structure dropdown
    xyzFiles.forEach(file => {
      const option = document.createElement('option');
      option.value = file;
      option.text = file;
      select.appendChild(option);
    });

    // Helper: set the chosen rendering style
    function setStyle(style) {
      if (!viewer) return;
      viewer.setStyle({}, {}); // clear all styles
      if (style === 'stick') {
        viewer.setStyle({}, { stick: {} });
      } else if (style === 'ballstick') {
        viewer.setStyle({}, { stick: {}, sphere: { scale: 0.3 } });
      } else if (style === 'sphere') {
        viewer.setStyle({}, { sphere: {} });
      }
      viewer.zoomTo();
      viewer.render();
    }

    // Helper: display details from metadata
    function updateDetails(filepath) {
      const meta = metadata[filepath];
      if (!meta) {
        document.getElementById('details-content').innerHTML = "No metadata available for this structure.";
        return;
      }
      // Stoichiometry string
      const stoich = Object.entries(meta.stoichiometry || {})
        .map(([el, count]) => `${el} (${count})`)
        .join(', ') || 'N/A';
      // Ratios string
      const ratiosEntries = meta.ratios || {};
      const ratiosStrings = Object.entries(ratiosEntries)
        .map(([pair, val]) => `${pair} = ${val}`)
        .join(', ');
      const ratiosDisplay = ratiosStrings || 'N/A';
      // Size display
      let sizeDisplay = 'N/A';
      if (meta.size != null) {
        sizeDisplay = meta.size + (meta.size_units ? ` ${meta.size_units}` : '');
      }
      // Build HTML
      const html = `
        <b>System type:</b> ${meta.system_type || 'N/A'}<br>
        <b>Material:</b> ${meta.material || 'N/A'}<br>
        <b>Size:</b> ${sizeDisplay}<br>
        <b>DFT functional:</b> ${meta.functional || 'N/A'}<br>
        <b>DFT code:</b> ${meta.code || 'N/A'}<br>
        <b>Run Type:</b> ${meta.run_type || 'N/A'}<br>
        <b>Stoichiometry:</b> ${stoich}<br>
        <b>Ratios:</b> ${ratiosDisplay}<br>
        <b>Filename:</b> ${meta.filename}
      `;
      document.getElementById('details-content').innerHTML = html;
    }

    // Load and render an XYZ file
    function loadXYZ(file) {
      fetch(file)
        .then(response => {
          if (!response.ok) throw new Error("File not found");
          return response.text();
        })
        .then(data => {
          // Initialize or reset viewer
          viewerDiv.innerHTML = "";
          viewer = $3Dmol.createViewer(viewerDiv, { backgroundColor: 'white' });
          viewer.addModel(data, 'xyz');
          setStyle(styleSelect.value);
          updateDetails(file);
        })
        .catch(() => {
          viewerDiv.innerHTML = "<b>Error loading file.</b>";
          document.getElementById('details-content').innerHTML = "<b>No details available.</b>";
        });
    }

    // Initial load if there are any files
    if (xyzFiles.length > 0) {
      loadXYZ(xyzFiles[0]);
    }

    // Event listeners
    select.addEventListener('change', () => loadXYZ(select.value));
    styleSelect.addEventListener('change', () => setStyle(styleSelect.value));
  </script>
</body>
</html>

